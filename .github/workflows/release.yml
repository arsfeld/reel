name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.1.0, v0.1.0-beta1, v0.1.0-alpha1)"
        required: true
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_prerelease: ${{ steps.check_prerelease.outputs.is_prerelease }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if prerelease
        id: check_prerelease
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          # Auto-detect prerelease based on tag pattern or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Manual prerelease flag set"
          elif [[ "$VERSION" =~ -(alpha|beta|rc|dev|pre) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Auto-detected prerelease from version: $VERSION"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "Stable release: $VERSION"
          fi

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view ${{ steps.get_version.outputs.version }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release already exists for ${{ steps.get_version.outputs.version }}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No release found for ${{ steps.get_version.outputs.version }}"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Generate release notes
        id: generate_notes
        if: steps.check_release.outputs.exists == 'false'
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ steps.get_version.outputs.version }}^ 2>/dev/null || echo "")

          # Get commit messages between tags
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..${{ steps.get_version.outputs.version }})
          else
            COMMITS=$(git log --pretty=format:"- %s" --max-count=20)
          fi

          # Save to output (escape newlines for GitHub Actions)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Build release body
        id: build_body
        if: steps.check_release.outputs.exists == 'false'
        run: |
          cat > release_body.md << 'RELEASE_BODY'
          ${{ steps.check_prerelease.outputs.is_prerelease == 'true' && '
          > ⚠️ **This is a prerelease version** - It may contain bugs and is intended for testing purposes. Use stable releases for production.
          ' || '' }}
          ## Changes
          ${{ steps.generate_notes.outputs.notes || '- Initial release' }}

          ## Downloads
          - **Linux Tarball**: `reel-linux-x86_64.tar.gz` - Extract and run `./reel`
          - **Debian/Ubuntu**: `reel-${{ steps.get_version.outputs.version }}-amd64.deb` - Install with `sudo dpkg -i`
          - **Fedora/RHEL**: `reel-${{ steps.get_version.outputs.version }}-x86_64.rpm` - Install with `sudo rpm -i`
          - **AppImage**: `reel-${{ steps.get_version.outputs.version }}-x86_64.AppImage` - Portable, runs on most Linux distributions

          ## Installation

          ### AppImage (Recommended)
          ```bash
          chmod +x reel-${{ steps.get_version.outputs.version }}-x86_64.AppImage
          ./reel-${{ steps.get_version.outputs.version }}-x86_64.AppImage
          ```

          ### Debian/Ubuntu
          ```bash
          sudo dpkg -i reel-${{ steps.get_version.outputs.version }}-amd64.deb
          sudo apt-get install -f  # Install dependencies if needed
          ```

          ### Fedora/RHEL/openSUSE
          ```bash
          sudo rpm -i reel-${{ steps.get_version.outputs.version }}-x86_64.rpm
          # or
          sudo dnf install ./reel-${{ steps.get_version.outputs.version }}-x86_64.rpm
          ```

          ### Manual Installation
          ```bash
          tar -xzf reel-linux-x86_64.tar.gz
          chmod +x reel
          ./reel
          ```

          ## System Requirements
          - GTK4 and libadwaita
          - GStreamer with common plugins
          - 64-bit operating system
          RELEASE_BODY

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Reel ${{ steps.get_version.outputs.version }}${{ steps.check_prerelease.outputs.is_prerelease == 'true' && ' (Prerelease)' || '' }}
          draft: true
          prerelease: ${{ steps.check_prerelease.outputs.is_prerelease == 'true' }}
          body_path: ${{ steps.check_release.outputs.exists == 'false' && 'release_body.md' || '' }}

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libadwaita-1-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-bad1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav \
            libmpv-dev \
            libsqlite3-dev \
            pkg-config \
            libssl-dev \
            libdbus-1-dev \
            blueprint-compiler \
            rpm \
            file

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-release-

      - name: Install cargo packaging tools
        run: |
          cargo install cargo-deb --locked || true
          cargo install cargo-generate-rpm --locked || true

      - name: Build release binary
        run: |
          cargo build --release
          strip target/release/reel

      - name: Package as tarball
        run: |
          cp target/release/reel reel
          tar -czf reel-linux-x86_64.tar.gz reel

      - name: Build Debian package
        run: |
          cargo deb --no-build
          mv target/debian/*.deb reel-${{ needs.create-release.outputs.version }}-amd64.deb || true

      - name: Build RPM package
        run: |
          cargo generate-rpm
          mv target/generate-rpm/*.rpm reel-${{ needs.create-release.outputs.version }}-x86_64.rpm || true

      - name: Setup AppImage tools
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          wget -q https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-plugin-gtk.sh

      - name: Install additional AppImage dependencies
        run: |
          # Install additional dependencies that LinuxDeploy might need
          sudo apt-get install -y \
            libfuse2 \
            desktop-file-utils \
            zsync

      - name: Build AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps

          # Copy our files
          cp target/release/reel AppDir/usr/bin/
          chmod +x AppDir/usr/bin/reel
          cp data/dev.arsfeld.Reel.desktop AppDir/usr/share/applications/
          cp data/icons/hicolor/scalable/apps/dev.arsfeld.Reel.svg AppDir/usr/share/icons/hicolor/scalable/apps/

          # Set environment variables for better dependency detection
          export VERSION=${{ needs.create-release.outputs.version }}
          export DEPLOY_GTK_VERSION=4
          export LINUXDEPLOY_OUTPUT_VERSION=$VERSION

          # Add library paths for better detection
          export LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"

          echo "=== Running LinuxDeploy with GTK4 plugin ==="
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable AppDir/usr/bin/reel \
            --desktop-file AppDir/usr/share/applications/dev.arsfeld.Reel.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/scalable/apps/dev.arsfeld.Reel.svg \
            --plugin gtk \
            --output appimage

          # Rename the output to our convention
          if ls Reel-*.AppImage 1> /dev/null 2>&1; then
            mv Reel-*.AppImage reel-${{ needs.create-release.outputs.version }}-x86_64.AppImage
            echo "✓ Renamed AppImage to reel-${{ needs.create-release.outputs.version }}-x86_64.AppImage"
          elif ls *.AppImage 1> /dev/null 2>&1; then
            # Fallback: find any AppImage that's not the tools
            for img in *.AppImage; do
              if [[ "$img" != linuxdeploy-*.AppImage ]]; then
                mv "$img" reel-${{ needs.create-release.outputs.version }}-x86_64.AppImage
                echo "✓ Renamed $img to reel-${{ needs.create-release.outputs.version }}-x86_64.AppImage"
                break
              fi
            done
          else
            echo "✗ No AppImage found after build"
            ls -la
            exit 1
          fi

          # Verify the AppImage was created successfully
          if [ -f "reel-${{ needs.create-release.outputs.version }}-x86_64.AppImage" ]; then
            echo "✓ AppImage created successfully"
            file "reel-${{ needs.create-release.outputs.version }}-x86_64.AppImage"
            ls -lh "reel-${{ needs.create-release.outputs.version }}-x86_64.AppImage"
          else
            echo "✗ Expected AppImage file not found"
            ls -la *.AppImage 2>/dev/null || echo "No AppImage files found"
            exit 1
          fi

      - name: Upload Linux Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: |
            reel-linux-x86_64.tar.gz
            reel-*.deb
            reel-*.rpm
            reel-*.AppImage

  # macOS and Windows builds are disabled for now - we only test on Linux
  # Uncomment the sections below to enable multi-platform builds

  # build-macos:
  #   needs: create-release
  #   runs-on: macos-latest
  #   permissions:
  #     contents: write
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Install dependencies
  #       run: |
  #         brew install gtk4 libadwaita gstreamer gst-plugins-base gst-plugins-good gst-plugins-bad gst-plugins-ugly gst-libav pkg-config blueprint-compiler create-dmg
  #
  #     - name: Setup Rust
  #       uses: dtolnay/rust-toolchain@stable
  #
  #     - name: Cache cargo dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           ~/.cargo/bin/
  #           ~/.cargo/registry/index/
  #           ~/.cargo/registry/cache/
  #           ~/.cargo/git/db/
  #           target/
  #         key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: ${{ runner.os }}-cargo-release-
  #
  #     - name: Build release binary
  #       run: |
  #         cargo build --release
  #         strip target/release/reel
  #
  #     - name: Create macOS app bundle
  #       run: |
  #         mkdir -p Reel.app/Contents/MacOS
  #         mkdir -p Reel.app/Contents/Resources
  #         cp target/release/reel Reel.app/Contents/MacOS/reel
  #
  #         # Create Info.plist
  #         cat > Reel.app/Contents/Info.plist << EOF
  #         <?xml version="1.0" encoding="UTF-8"?>
  #         <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  #         <plist version="1.0">
  #         <dict>
  #             <key>CFBundleExecutable</key>
  #             <string>reel</string>
  #             <key>CFBundleIdentifier</key>
  #             <string>org.gnome.Reel</string>
  #             <key>CFBundleName</key>
  #             <string>Reel</string>
  #             <key>CFBundleDisplayName</key>
  #             <string>Reel Media Player</string>
  #             <key>CFBundlePackageType</key>
  #             <string>APPL</string>
  #             <key>CFBundleShortVersionString</key>
  #             <string>${{ needs.create-release.outputs.version }}</string>
  #             <key>CFBundleVersion</key>
  #             <string>1</string>
  #             <key>LSMinimumSystemVersion</key>
  #             <string>10.15</string>
  #             <key>NSHighResolutionCapable</key>
  #             <true/>
  #             <key>NSSupportsAutomaticGraphicsSwitching</key>
  #             <true/>
  #         </dict>
  #         </plist>
  #         EOF
  #
  #     - name: Create DMG
  #       run: |
  #         create-dmg \
  #           --volname "Reel Media Player" \
  #           --window-pos 200 120 \
  #           --window-size 600 400 \
  #           --icon-size 100 \
  #           --icon "Reel.app" 175 190 \
  #           --hide-extension "Reel.app" \
  #           --app-drop-link 425 190 \
  #           "reel-macos-universal.dmg" \
  #           "Reel.app"
  #
  #     - name: Upload macOS Release Asset
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         tag_name: ${{ needs.create-release.outputs.version }}
  #         files: reel-macos-universal.dmg

  # build-windows:
  #   needs: create-release
  #   runs-on: windows-latest
  #   permissions:
  #     contents: write
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Setup Rust
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         targets: x86_64-pc-windows-gnu
  #
  #     - uses: msys2/setup-msys2@v2
  #       with:
  #         msystem: MINGW64
  #         update: true
  #         install: >-
  #           mingw-w64-x86_64-gtk4
  #           mingw-w64-x86_64-libadwaita
  #           mingw-w64-x86_64-gstreamer
  #           mingw-w64-x86_64-gst-plugins-base
  #           mingw-w64-x86_64-gst-plugins-good
  #           mingw-w64-x86_64-gst-plugins-bad
  #           mingw-w64-x86_64-gst-plugins-ugly
  #           mingw-w64-x86_64-gst-libav
  #           mingw-w64-x86_64-pkg-config
  #           mingw-w64-x86_64-gcc
  #           mingw-w64-x86_64-blueprint-compiler
  #           base-devel
  #           zip
  #
  #     - name: Cache cargo dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           ~/.cargo/bin/
  #           ~/.cargo/registry/index/
  #           ~/.cargo/registry/cache/
  #           ~/.cargo/git/db/
  #           target/
  #         key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: ${{ runner.os }}-cargo-release-
  #
  #     - name: Build release binary
  #       shell: msys2 {0}
  #       run: |
  #         export PATH="/c/Users/runneradmin/.cargo/bin:$PATH"
  #         export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:$PKG_CONFIG_PATH"
  #         cargo build --release
  #         strip target/release/reel.exe
  #
  #     - name: Package Windows executable
  #       shell: msys2 {0}
  #       run: |
  #         mkdir -p dist/Reel
  #         cp target/release/reel.exe dist/Reel/reel.exe
  #
  #         # Copy required DLLs
  #         ldd target/release/reel.exe | grep mingw64 | awk '{print $3}' | xargs -I {} cp {} dist/Reel/
  #
  #         # Create README
  #         cat > dist/Reel/README.txt << EOF
  #         Reel Media Player for Windows
  #         ==============================
  #
  #         To run Reel, simply double-click reel.exe
  #
  #         If you encounter any issues with missing DLLs, please ensure you have:
  #         - Visual C++ Redistributables installed
  #         - GTK4 runtime (included in this package)
  #
  #         For support, visit: https://github.com/yourusername/reel
  #         EOF
  #
  #         # Create zip archive
  #         cd dist && zip -r ../reel-windows-x86_64.zip Reel && cd ..
  #
  #     - name: Upload Windows Release Asset
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         tag_name: ${{ needs.create-release.outputs.version }}
  #         files: reel-windows-x86_64.zip
